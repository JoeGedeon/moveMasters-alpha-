import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc } from 'firebase/firestore';
import { 
  LayoutDashboard, Camera, Users, Truck, Calculator, Settings, 
  ChevronLeft, ChevronRight, Zap, Loader2, Edit3, Plus, 
  Package, Home, MapPin, ClipboardList, Clock, X, Trash2, Boxes,
  Navigation, ShieldAlert, Archive, Image as ImageIcon, CheckCircle
} from 'lucide-react';

// --- SYSTEM CONFIG ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'titan-x47-open';
const apiKey = ""; 

const App = () => {
  const [user, setUser] = useState(null);
  const [isHydrated, setIsHydrated] = useState(false);
  const [activeTab, setActiveTab] = useState('Dashboard');
  const [customers, setCustomers] = useState([]);
  const [currentMonth, setCurrentMonth] = useState(new Date(2025, 11, 1));
  const [selectedDate, setSelectedDate] = useState('2025-12-22');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [editingJob, setEditingJob] = useState(null);
  const [isSyncing, setIsSyncing] = useState(false);

  const initialForm = {
    name: '', phone: '', email: '', moveType: 'Local',
    fromStreet: '', fromCity: '', fromZip: '',
    toStreet: '', toCity: '', toZip: '',
    houseSize: '2BR Apartment', floors: '1st Floor', stairs: 'No', elevator: 'No',
    packing: 'Self', longCarry: 'No', shuttle: 'No', storage: 'No',
    date: '', time: '09:00', vol: 0,
    inventoryItems: [], images: [] 
  };
  const [appForm, setAppForm] = useState(initialForm);

  // --- 1. CLOUD HYDRATION ---
  useEffect(() => {
    const initAuth = async () => {
      let currentUser;
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        const res = await signInWithCustomToken(auth, __initial_auth_token);
        currentUser = res.user;
      } else {
        const res = await signInAnonymously(auth);
        currentUser = res.user;
      }
      setUser(currentUser);
      const stateRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'system', 'state');
      const snap = await getDoc(stateRef);
      if (snap.exists()) {
        const data = snap.data();
        if (data.activeTab) setActiveTab(data.activeTab);
        if (data.customers) setCustomers(data.customers);
      }
      setIsHydrated(true);
    };
    initAuth();
  }, []);

  const saveToCloud = async (tab, list) => {
    if (!user) return;
    const stateRef = doc(db, 'artifacts', appId, 'users', user.uid, 'system', 'state');
    try { await setDoc(stateRef, { activeTab: tab, customers: list, timestamp: Date.now() }, { merge: true }); } 
    catch (e) { console.error(e); }
  };

  // --- 2. VISION AUDIT ---
  const handlePhotoUpload = (e, mode = 'intake') => {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onloadend = () => {
        if (mode === 'intake') setAppForm(p => ({ ...p, images: [...(p.images || []), reader.result] }));
        else if (editingJob) setEditingJob(p => ({ ...p, images: [...(p.images || []), reader.result] }));
      };
      reader.readAsDataURL(file);
    });
  };

  const performAIAudit = async (mode = 'intake') => {
    const target = mode === 'intake' ? appForm : editingJob;
    if (!target?.images?.length) return;
    setIsAnalyzing(true);
    const imageParts = target.images.slice(-4).map(b => ({ inlineData: { mimeType: "image/png", data: b.split(',')[1] } }));
    const prompt = "Moving Inventory: Identify items. Return JSON: { \"items\": [{\"name\": string, \"vol\": number}], \"total\": number }";
    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, ...imageParts] }], generationConfig: { responseMimeType: "application/json" } })
      });
      const data = JSON.parse((await res.json()).candidates[0].content.parts[0].text);
      if (mode === 'intake') setAppForm(p => ({ ...p, vol: data.total, inventoryItems: data.items }));
      else setEditingJob(p => ({ ...p, vol: data.total, inventoryItems: data.items }));
    } catch (err) { console.error(err); } finally { setIsAnalyzing(false); }
  };

  // --- 3. MASTER SYNC ENGINE ---
  const handleSync = () => {
    if (!appForm.name || !appForm.date) return;
    setIsSyncing(true);
    const truckType = appForm.vol > 650 ? "Titan-Heavy" : "MM-Lite";
    const newJob = { ...appForm, id: Date.now(), truck: truckType, status: "Synced", route: `${appForm.fromZip} ➔ ${appForm.toZip}` };
    const updatedList = [newJob, ...customers];
    setCustomers(updatedList);
    setAppForm(initialForm);
    setSelectedDate(newJob.date);
    setActiveTab('Dashboard'); // Force jump back
    saveToCloud('Dashboard', updatedList);
    setIsSyncing(false);
  };

  const finalizeEdit = () => {
    if (!editingJob) return;
    const updatedList = customers.map(c => c.id === editingJob.id ? { ...editingJob, route: `${editingJob.fromZip} ➔ ${editingJob.toZip}` } : c);
    setCustomers(updatedList);
    saveToCloud(activeTab, updatedList);
    setEditingJob(null);
  };

  // --- 4. CALENDAR RENDERER ---
  const calendarContent = useMemo(() => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const rows = [];
    let cells = [];

    for (let i = 0; i < firstDay; i++) cells.push(<td key={`e-${i}`} className="h-28 md:h-32 border border-white/[0.03]"></td>);
    for (let d = 1; d <= daysInMonth; d++) {
      const dKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const dayJobs = customers.filter(c => c.date === dKey).sort((a,b) => (a.time || '').localeCompare(b.time || ''));
      cells.push(
        <td key={d} onClick={() => setSelectedDate(dKey)} className={`h-28 md:h-32 border border-white/5 bg-zinc-950/20 p-2 cursor-pointer transition-all align-top ${selectedDate === dKey ? 'ring-2 ring-blue-500 bg-blue-500/5' : 'hover:bg-zinc-900/50'}`}>
          <span className={`text-[10px] font-black mb-1 block ${dayJobs.length > 0 ? 'text-blue-400' : 'text-zinc-700'}`}>{d}</span>
          <div className="space-y-1">
            {dayJobs.slice(0, 3).map((j, i) => (
              <div key={i} className={`text-[8px] md:text-[9px] px-1.5 py-1 rounded border font-bold truncate uppercase ${j.truck?.includes('Heavy') ? 'bg-blue-600/20 border-blue-500/30 text-blue-200' : 'bg-zinc-800 border-white/5 text-zinc-400'}`}>
                {j.time} {j.name?.split(' ')[0]}
              </div>
            ))}
          </div>
        </td>
      );
      if (cells.length === 7) { rows.push(<tr key={d}>{cells}</tr>); cells = []; }
    }
    while(cells.length > 0 && cells.length < 7) cells.push(<td key={`f-${cells.length}`} className="h-28 md:h-32 border border-white/[0.03]"></td>);
    if(cells.length > 0) rows.push(<tr key="last">{cells}</tr>);
    return rows;
  }, [currentMonth, customers, selectedDate]);

  if (!isHydrated) return <div className="h-screen w-screen bg-black flex items-center justify-center"><Loader2 className="animate-spin text-blue-500" size={40} /></div>;

  return (
    <div className="fixed inset-0 bg-black text-white flex overflow-hidden font-sans select-none">
      
      {/* SIDEBAR NAVIGATION */}
      <aside className="w-[260px] bg-zinc-950 border-r border-white/5 flex flex-col shrink-0 z-50">
        <div className="p-8 border-b border-white/5"><h1 className="text-[13px] font-black uppercase tracking-[0.5em] italic text-blue-500">Titan OS</h1></div>
        <nav className="flex-1 overflow-y-auto p-4 space-y-1">
          {[
            { id: 'Dashboard', icon: <LayoutDashboard size={18}/> },
            { id: 'Customer List', icon: <ClipboardList size={18}/> },
            { id: 'CRM', icon: <Users size={18}/> },
            { id: 'Audit', icon: <Calculator size={18}/> },
            { id: 'Fleet', icon: <Truck size={18}/> },
            { id: 'Settings', icon: <Settings size={18}/> }
          ].map(item => (
            <button key={item.id} onClick={() => { setActiveTab(item.id); saveToCloud(item.id, customers); }} className={`w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold transition-all text-sm ${activeTab === item.id ? 'bg-blue-600/10 text-blue-400 border-l-4 border-blue-500 shadow-lg' : 'text-zinc-600 hover:bg-white/5'}`}>
              {item.icon} {item.id}
            </button>
          ))}
        </nav>
      </aside>

      {/* MAIN STAGE */}
      <main className="flex-1 overflow-hidden relative flex flex-col">
        <div className="flex-1 overflow-y-auto p-8 md:p-12 custom-scrollbar">
          <header className="mb-8 flex justify-between items-end"><h2 className="text-6xl md:text-8xl font-black italic uppercase tracking-tighter titan-gradient leading-none">{activeTab}</h2></header>

          {/* VIEW: DASHBOARD */}
          {activeTab === 'Dashboard' && (
            <div className="grid grid-cols-1 lg:grid-cols-4 gap-8 max-w-7xl animate-in fade-in">
              <div className="lg:col-span-3 space-y-10">
                <div className="bg-zinc-950 border border-white/5 rounded-[40px] overflow-hidden shadow-2xl">
                  <div className="flex justify-between items-center p-8">
                    <h3 className="text-2xl font-black italic uppercase titan-gradient">{new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentMonth)}</h3>
                    <div className="flex gap-2">
                      <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1))} className="p-3 bg-white/5 rounded-xl hover:bg-blue-600 transition-colors"><ChevronLeft size={18}/></button>
                      <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1))} className="p-3 bg-white/5 rounded-xl hover:bg-blue-600 transition-colors"><ChevronRight size={18}/></button>
                    </div>
                  </div>
                  <table className="w-full table-fixed border-collapse">
                    <thead><tr className="bg-zinc-950">{['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(day => <th key={day} className="py-4 text-[9px] font-black text-zinc-800 uppercase border-b border-white/5">{day}</th>)}</tr></thead>
                    <tbody>{calendarContent}</tbody>
                  </table>
                </div>
                <div className="grid grid-cols-2 gap-8">
                   <div className="bg-zinc-900/50 border border-white/5 p-10 rounded-[50px] shadow-xl">
                      <p className="text-zinc-600 uppercase font-black text-[10px] mb-4 tracking-widest italic">Revenue node</p><h4 className="text-6xl font-black italic">$142,850</h4>
                   </div>
                   <div className="bg-zinc-900/50 border border-white/5 p-10 rounded-[50px] shadow-xl">
                      <p className="text-blue-500 uppercase font-black text-[10px] mb-4 tracking-widest italic">Sync integrity</p><h4 className="text-6xl font-black italic text-blue-400">99.1%</h4>
                   </div>
                </div>
              </div>

              <div className="bg-zinc-900/50 border border-white/5 rounded-[40px] p-8 h-fit sticky top-0 shadow-2xl">
                <h4 className="text-lg font-black uppercase titan-gradient mb-6 tracking-widest">Day Node</h4>
                <div className="space-y-4">
                  <p className="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-6">{new Date(selectedDate + "T00:00:00").toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</p>
                  {customers.filter(c => c.date === selectedDate).map((j, i) => (
                    <div key={i} className="bg-zinc-950 p-6 rounded-3xl border border-white/10 group transition-all hover:border-blue-500/30">
                      <div className="flex justify-between items-start mb-4">
                        <span className="text-xl font-black italic text-white leading-tight">{j.name}</span>
                        <button onClick={() => setEditingJob({...j})} className="p-2 text-blue-500 hover:bg-blue-500/10 rounded-lg"><Edit3 size={14}/></button>
                      </div>
                      <div className="flex items-center justify-between text-[9px] font-black uppercase text-zinc-500">
                        <span><Clock size={10} className="inline mr-1"/> {j.time}</span>
                        <span><Truck size={10} className="inline mr-1"/> {j.truck}</span>
                      </div>
                    </div>
                  ))}
                  <button onClick={() => { setActiveTab('Customer List'); }} className="w-full py-4 border-2 border-dashed border-white/5 rounded-3xl text-zinc-700 text-xs font-black uppercase hover:border-blue-500/30 hover:text-zinc-400 transition-all">Add Node</button>
                </div>
              </div>
            </div>
          )}

          {/* VIEW: CUSTOMER LIST (WIDE OPEN CONSOLE) */}
          {activeTab === 'Customer List' && (
            <div className="space-y-12 max-w-[1600px] animate-in slide-in-from-bottom duration-500 pb-40">
              
              {/* THE 3-COLUMN MASTER FORM */}
              <div className="grid grid-cols-1 xl:grid-cols-3 gap-8">
                
                {/* 01 IDENTITY NODE */}
                <div className="bg-zinc-900/80 border border-white/5 p-10 rounded-[50px] shadow-2xl space-y-6">
                  <div className="flex items-center gap-3 mb-4"><Users className="text-blue-500" size={20}/><span className="text-[11px] font-black uppercase text-white tracking-[0.3em]">01 Customer Identity</span></div>
                  <input type="text" placeholder="Full Legal Name" className="w-full bg-black p-5 rounded-2xl border border-white/10 font-bold" value={appForm.name} onChange={e=>setAppForm({...appForm, name: e.target.value})}/>
                  <input type="tel" placeholder="Mobile Node" className="w-full bg-black p-5 rounded-2xl border border-white/10 font-bold" value={appForm.phone} onChange={e=>setAppForm({...appForm, phone: e.target.value})}/>
                  <input type="email" placeholder="Email Sync" className="w-full bg-black p-5 rounded-2xl border border-white/10 font-bold" value={appForm.email} onChange={e=>setAppForm({...appForm, email: e.target.value})}/>
                  <select className="w-full bg-black p-5 rounded-2xl border border-white/10 font-bold text-sm" value={appForm.moveType} onChange={e=>setAppForm({...appForm, moveType: e.target.value})}><option>Local Move</option><option>Long Distance</option><option>Commercial Dispatch</option></select>
                </div>

                {/* 02 LOGISTICS NODE */}
                <div className="bg-zinc-900/80 border border-white/5 p-10 rounded-[50px] shadow-2xl space-y-6">
                  <div className="flex items-center gap-3 mb-4"><Navigation className="text-blue-500" size={20}/><span className="text-[11px] font-black uppercase text-white tracking-[0.3em]">02 Logistics Route</span></div>
                  <div className="grid grid-cols-1 gap-4">
                    <div className="p-4 bg-black rounded-2xl border border-white/5 space-y-3">
                      <p className="text-[9px] font-black uppercase text-zinc-600">Origin</p>
                      <input type="text" placeholder="Street" className="w-full bg-zinc-900/50 p-3 rounded-xl border border-white/5 text-xs font-bold" value={appForm.fromStreet} onChange={e=>setAppForm({...appForm, fromStreet: e.target.value})}/>
                      <div className="grid grid-cols-2 gap-2">
                        <input type="text" placeholder="City" className="bg-zinc-900/50 p-3 rounded-xl border border-white/5 text-xs font-bold" value={appForm.fromCity} onChange={e=>setAppForm({...appForm, fromCity: e.target.value})}/>
                        <input type="text" placeholder="Zip" className="bg-zinc-900/50 p-3 rounded-xl border border-white/5 text-xs font-bold" value={appForm.fromZip} onChange={e=>setAppForm({...appForm, fromZip: e.target.value})}/>
                      </div>
                    </div>
                    <div className="p-4 bg-black rounded-2xl border border-white/5 space-y-3">
                      <p className="text-[9px] font-black uppercase text-zinc-600">Destination</p>
                      <input type="text" placeholder="Street" className="w-full bg-zinc-900/50 p-3 rounded-xl border border-white/5 text-xs font-bold" value={appForm.toStreet} onChange={e=>setAppForm({...appForm, toStreet: e.target.value})}/>
                      <div className="grid grid-cols-2 gap-2">
                        <input type="text" placeholder="City" className="bg-zinc-900/50 p-3 rounded-xl border border-white/5 text-xs font-bold" value={appForm.toCity} onChange={e=>setAppForm({...appForm, toCity: e.target.value})}/>
                        <input type="text" placeholder="Zip" className="bg-zinc-900/50 p-3 rounded-xl border border-white/5 text-xs font-bold" value={appForm.toZip} onChange={e=>setAppForm({...appForm, toZip: e.target.value})}/>
                      </div>
                    </div>
                  </div>
                </div>

                {/* 03 OPERATIONAL NODE */}
                <div className="bg-zinc-900/80 border border-white/5 p-10 rounded-[50px] shadow-2xl space-y-6">
                  <div className="flex items-center gap-3 mb-4"><ShieldAlert className="text-blue-500" size={20}/><span className="text-[11px] font-black uppercase text-white tracking-[0.3em]">03 operational access</span></div>
                  <div className="grid grid-cols-2 gap-4">
                    <select className="bg-black p-5 rounded-2xl border border-white/10 font-bold text-sm" value={appForm.houseSize} onChange={e=>setAppForm({...appForm, houseSize: e.target.value})}><option>Studio</option><option>1BR Apartment</option><option>2BR Apartment</option><option>3BR House</option><option>Estate</option></select>
                    <select className="bg-black p-5 rounded-2xl border border-white/10 font-bold text-sm" value={appForm.floors} onChange={e=>setAppForm({...appForm, floors: e.target.value})}><option>1st Floor</option><option>2nd Floor</option><option>Elevator</option></select>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    {['Long Carry', 'Shuttle', 'Storage', 'Full Pack'].map(feat => (
                      <button key={feat} onClick={() => setAppForm({...appForm, [feat.toLowerCase().replace(' ', '')]: appForm[feat.toLowerCase().replace(' ', '')] === 'Yes' ? 'No' : 'Yes'})} className={`p-4 rounded-2xl border font-black text-[9px] uppercase transition-all ${appForm[feat.toLowerCase().replace(' ', '')] === 'Yes' ? 'bg-blue-600 border-blue-500 shadow-lg shadow-blue-900/20' : 'bg-black border-white/10 text-zinc-600'}`}>{feat}</button>
                    ))}
                  </div>
                  <div className="grid grid-cols-2 gap-4 pt-4">
                    <input type="date" className="bg-black p-5 rounded-2xl border border-white/10 font-bold text-zinc-500" value={appForm.date} onChange={e=>setAppForm({...appForm, date: e.target.value})}/>
                    <input type="time" className="bg-black p-5 rounded-2xl border border-white/10 font-bold" value={appForm.time} onChange={e=>setAppForm({...appForm, time: e.target.value})}/>
                  </div>
                  <button onClick={handleSync} disabled={isSyncing} className="w-full bg-blue-600 p-7 rounded-[35px] font-black uppercase italic tracking-widest hover:bg-blue-500 shadow-2xl shadow-blue-900/40 flex items-center justify-center gap-3">
                    {isSyncing ? <Loader2 className="animate-spin"/> : <><Zap fill="currentColor" size={20}/> Synchronize Command Node</>}
                  </button>
                </div>
              </div>

              {/* 04 MULTI-VISION SURVEY (OPEN GALLERY) */}
              <div className="grid grid-cols-1 xl:grid-cols-2 gap-12">
                 <div className="bg-zinc-900/80 border border-blue-500/20 p-10 rounded-[50px] shadow-2xl">
                    <div className="flex justify-between items-center mb-8"><span className="flex items-center gap-3 text-[11px] font-black text-blue-400 uppercase tracking-[0.3em] italic"><Camera size={20}/> 04 Multi-Vision survey</span>{isAnalyzing && <Loader2 className="animate-spin text-blue-500"/>}</div>
                    <div className="grid grid-cols-4 gap-4 mb-8">
                      {appForm.images.map((img, idx) => (<div key={idx} className="relative aspect-square rounded-2xl overflow-hidden border border-white/10 group"><img src={img} className="w-full h-full object-cover" /><button onClick={() => setAppForm(p=>({...p, images: p.images.filter((_,i)=>i!==idx)}))} className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center text-rose-500"><Trash2 size={24}/></button></div>))}
                      <div className="relative aspect-square bg-black border-2 border-dashed border-white/10 rounded-2xl flex flex-col items-center justify-center group hover:border-blue-500/50 transition-all cursor-pointer"><Camera size={32} className="text-zinc-800" /><span className="text-[8px] font-black uppercase text-zinc-700 mt-2">Add Photo</span><input type="file" multiple accept="image/*" className="absolute inset-0 opacity-0" onChange={(e) => handlePhotoUpload(e, 'intake')}/></div>
                    </div>
                    {appForm.images.length > 0 && <button onClick={() => performAIAudit('intake')} disabled={isAnalyzing} className="w-full py-5 bg-zinc-800 rounded-3xl font-black uppercase text-[11px] tracking-widest border border-white/5 hover:bg-zinc-700 transition-all flex items-center justify-center gap-3 shadow-xl">{isAnalyzing ? <Loader2 className="animate-spin" size={16}/> : <Zap size={16} className="text-blue-500"/>} Run Collective AI Audit</button>}
                 </div>

                 {appForm.inventoryItems.length > 0 && (
                  <div className="bg-zinc-950 p-10 rounded-[50px] border border-white/5 shadow-2xl space-y-6">
                    <div className="flex justify-between items-end border-b border-white/5 pb-6">
                      <div><p className="text-[10px] font-black uppercase text-zinc-600 mb-2">Audited Volume</p><h4 className="text-5xl font-black italic text-blue-400">{appForm.vol} ft³</h4></div>
                      <p className="text-[10px] font-black uppercase text-zinc-500 italic flex items-center gap-2"><Boxes size={14}/> {appForm.inventoryItems.length} Identified Nodes</p>
                    </div>
                    <div className="grid grid-cols-2 gap-3 max-h-[300px] overflow-y-auto pr-4 custom-scrollbar">
                      {appForm.inventoryItems.map((item, idx) => (
                        <div key={idx} className="bg-zinc-900/50 p-4 rounded-2xl border border-white/5 flex justify-between items-center"><span className="text-[11px] font-bold text-zinc-400 truncate pr-2">{item.name}</span><span className="text-[10px] font-black text-blue-500 whitespace-nowrap">{item.vol} ft³</span></div>
                      ))}
                    </div>
                  </div>
                 )}
              </div>
            </div>
          )}
          
          {activeTab === 'CRM' && (
            <div className="bg-zinc-950 border border-white/5 rounded-[40px] overflow-hidden shadow-2xl animate-in fade-in">
              <table className="w-full text-left">
                <thead className="bg-white/5 text-[10px] font-black uppercase tracking-widest text-zinc-600">
                  <tr><th className="p-10">Client Identity</th><th className="p-10">Route Node</th><th className="p-10">Audited Volume</th><th className="p-10">Sync Date</th><th className="p-10">Status</th></tr>
                </thead>
                <tbody className="divide-y divide-white/5">
                  {customers.map(c => (
                    <tr key={c.id} className="hover:bg-white/[0.02] transition-colors group">
                      <td className="p-10"><p className="font-black italic text-blue-400 text-2xl group-hover:translate-x-2 transition-transform">{c.name || 'Anonymous'}</p><p className="text-[10px] text-zinc-600 font-bold uppercase mt-1">{c.phone || 'Offline Node'}</p></td>
                      <td className="p-10 font-bold text-zinc-500">{c.route}</td>
                      <td className="p-10 font-black text-zinc-300">{c.vol || 0} ft³</td>
                      <td className="p-10 font-black italic">{c.date} <span className="text-zinc-600 text-xs">@ {c.time}</span></td>
                      <td className="p-10"><span className="bg-blue-600/10 text-blue-500 px-5 py-2 rounded-full text-[10px] font-black uppercase border border-blue-500/20">{c.status}</span></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>

        {/* LOGISTICS CONSOLE MODAL */}
        {editingJob && (
          <div className="fixed inset-0 bg-black/95 backdrop-blur-3xl z-[2000] flex overflow-y-auto p-4 md:p-12">
            <div className="bg-zinc-900 border border-white/10 rounded-[60px] p-10 md:p-16 max-w-6xl w-full mx-auto shadow-2xl animate-in zoom-in-95 self-start">
              <div className="flex justify-between items-center mb-12"><h4 className="text-4xl font-black italic uppercase titan-gradient tracking-tighter">Edit Command Node</h4><button onClick={() => setEditingJob(null)} className="p-3 bg-white/5 rounded-full hover:bg-rose-500 transition-all"><X size={24}/></button></div>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-16">
                <div className="space-y-8">
                  <div className="space-y-4">
                    <label className="text-[10px] font-black text-blue-500 uppercase tracking-widest ml-4">01 Identity Sync</label>
                    <input type="text" className="w-full bg-black p-6 rounded-3xl border border-white/10 font-black text-white text-xl" value={editingJob.name || ''} onChange={e=>setEditingJob({...editingJob, name:e.target.value})}/>
                    <div className="grid grid-cols-2 gap-4">
                       <input type="tel" className="bg-black p-6 rounded-3xl border border-white/10 font-bold" value={editingJob.phone || ''} onChange={e=>setEditingJob({...editingJob, phone:e.target.value})}/>
                       <input type="date" className="bg-black p-6 rounded-3xl border border-white/10 font-bold" value={editingJob.date || ''} onChange={e=>setEditingJob({...editingJob, date:e.target.value})}/>
                    </div>
                  </div>
                  <div className="space-y-4">
                    <label className="text-[10px] font-black text-blue-500 uppercase tracking-widest ml-4">02 Logistics Node</label>
                    <div className="grid grid-cols-2 gap-4">
                       <input type="text" placeholder="From Zip" className="bg-black p-6 rounded-3xl border border-white/10 font-bold text-center" value={editingJob.fromZip || ''} onChange={e=>setEditingJob({...editingJob, fromZip:e.target.value})}/>
                       <input type="text" placeholder="To Zip" className="bg-black p-6 rounded-3xl border border-white/10 font-bold text-center" value={editingJob.toZip || ''} onChange={e=>setEditingJob({...editingJob, toZip:e.target.value})}/>
                    </div>
                  </div>
                </div>
                <div className="space-y-8">
                   <div className="bg-black/50 border border-white/5 p-8 rounded-[40px] space-y-6 shadow-inner">
                      <div className="flex justify-between items-center"><span className="text-[11px] font-black text-blue-500 uppercase tracking-widest italic">Professional Audit gallery</span>{isAnalyzing && <Loader2 className="animate-spin text-blue-500"/>}</div>
                      <div className="grid grid-cols-3 gap-3">
                        {(editingJob.images || []).map((img, idx) => (<div key={idx} className="relative aspect-square rounded-2xl overflow-hidden group border border-white/10"><img src={img} className="w-full h-full object-cover" /><button onClick={() => setEditingJob(p=>({...p, images: p.images.filter((_,i)=>i!==idx)}))} className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center text-rose-500"><Trash2 size={20}/></button></div>))}
                        <div className="relative aspect-square bg-zinc-900 border-2 border-dashed border-white/10 rounded-2xl flex flex-col items-center justify-center group hover:border-blue-500/50 transition-all cursor-pointer"><Camera size={24} className="text-zinc-800" /><input type="file" multiple accept="image/*" className="absolute inset-0 opacity-0" onChange={(e) => handlePhotoUpload(e, 'edit')}/></div>
                      </div>
                      <button onClick={() => performAIAudit('edit')} className="w-full py-5 bg-blue-600/10 border border-blue-500/30 text-blue-400 font-black uppercase text-[10px] rounded-3xl hover:bg-blue-500 hover:text-white transition-all">Re-Run AI Inventory Node</button>
                      <div className="flex justify-between items-center pt-4 border-t border-white/5"><span className="text-[10px] font-black uppercase text-zinc-600">Audited volume</span><span className="text-3xl font-black italic text-blue-400">{editingJob.vol || 0} ft³</span></div>
                   </div>
                </div>
              </div>
              <button onClick={finalizeEdit} className="mt-12 w-full bg-blue-600 p-8 rounded-[40px] font-black uppercase italic tracking-widest text-lg hover:bg-blue-500 transition-all shadow-2xl">Finalize command node sync</button>
            </div>
          </div>
        )}
      </main>

      <style dangerouslySetInnerHTML={{ __html: `
        .titan-gradient { background: linear-gradient(to right, #ffffff, #3b82f6, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(59,130,246,0.1); border-radius: 10px; }
      `}} />
    </div>
  );
};

export default App;

