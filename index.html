import React, { useState, useEffect, useRef } from 'react';
import { 
  Calculator, 
  Receipt, 
  Plus, 
  Trash2, 
  History, 
  BrainCircuit, 
  Send,
  Loader2,
  TrendingUp,
  MapPin,
  Calendar,
  X
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, Timestamp } from 'firebase/firestore';

/**
 * FIREBASE CONFIGURATION & INITIALIZATION
 */
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'driver-log-v1';
const apiKey = ""; // Gemini API Key provided by environment

const App = () => {
  // App State
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('logs'); // 'logs', 'calc', 'ai'
  const [receipts, setReceipts] = useState([]);
  const [loading, setLoading] = useState(true);
  
  // Calculator State
  const [calcDisplay, setCalcDisplay] = useState('0');
  const [calcMemory, setCalcMemory] = useState(null);
  const [calcOperator, setCalcOperator] = useState(null);
  const [waitingForOperand, setWaitingForOperand] = useState(false);

  // AI Chat State
  const [chatInput, setChatInput] = useState('');
  const [chatHistory, setChatHistory] = useState([
    { role: 'assistant', text: "Hello! I'm your AI logistics assistant. I can help you analyze your receipt logs, summarize your spending, or estimate tax deductions based on your entries." }
  ]);
  const [isAiTyping, setIsAiTyping] = useState(false);

  // New Receipt Modal State
  const [showAddModal, setShowAddModal] = useState(false);
  const [newReceipt, setNewReceipt] = useState({
    amount: '',
    category: 'Fuel',
    location: '',
    date: new Date().toISOString().split('T')[0]
  });

  /**
   * FIREBASE AUTH & DATA SYNC (Rule 3: Auth Before Queries)
   */
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth error:", err);
      }
    };
    initAuth();
    const unsubscribeAuth = onAuthStateChanged(auth, setUser);
    return () => unsubscribeAuth();
  }, []);

  useEffect(() => {
    if (!user) return;

    // Rule 1: Use specific path structure
    const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'receipts'));
    
    // Set up real-time listener with error handling
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Rule 2: Sort in memory
      docs.sort((a, b) => b.timestamp?.toMillis() - a.timestamp?.toMillis());
      setReceipts(docs);
      setLoading(false);
    }, (error) => {
      console.error("Firestore error:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  /**
   * CALCULATOR LOGIC
   */
  const handleDigit = (digit) => {
    if (waitingForOperand) {
      setCalcDisplay(String(digit));
      setWaitingForOperand(false);
    } else {
      setCalcDisplay(calcDisplay === '0' ? String(digit) : calcDisplay + digit);
    }
  };

  const handleOperator = (nextOperator) => {
    const inputValue = parseFloat(calcDisplay);

    if (calcMemory === null) {
      setCalcMemory(inputValue);
    } else if (calcOperator) {
      const result = performCalculation();
      setCalcMemory(result);
      setCalcDisplay(String(result));
    }

    setWaitingForOperand(true);
    setCalcOperator(nextOperator);
  };

  const performCalculation = () => {
    const inputValue = parseFloat(calcDisplay);
    if (calcOperator === '+') return calcMemory + inputValue;
    if (calcOperator === '-') return calcMemory - inputValue;
    if (calcOperator === '*') return calcMemory * inputValue;
    if (calcOperator === '/') return calcMemory / inputValue;
    return inputValue;
  };

  const handleEqual = () => {
    if (!calcOperator) return;
    const result = performCalculation();
    setCalcDisplay(String(result));
    setCalcMemory(null);
    setCalcOperator(null);
    setWaitingForOperand(true);
  };

  const clearCalc = () => {
    setCalcDisplay('0');
    setCalcMemory(null);
    setCalcOperator(null);
    setWaitingForOperand(false);
  };

  const sendToReceipt = () => {
    setNewReceipt({ ...newReceipt, amount: calcDisplay });
    setShowAddModal(true);
  };

  /**
   * ACTION HANDLERS
   */
  const saveReceipt = async () => {
    if (!user || !newReceipt.amount) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'receipts'), {
        ...newReceipt,
        amount: parseFloat(newReceipt.amount),
        timestamp: Timestamp.now()
      });
      setShowAddModal(false);
      setNewReceipt({ amount: '', category: 'Fuel', location: '', date: new Date().toISOString().split('T')[0] });
      setActiveTab('logs');
    } catch (err) {
      console.error("Save error:", err);
    }
  };

  const deleteReceipt = async (id) => {
    if (!user) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'receipts', id));
    } catch (err) {
      console.error("Delete error:", err);
    }
  };

  const callGemini = async (prompt) => {
    setIsAiTyping(true);
    
    // Provide the AI with the user's receipt context
    const context = `
      User UID: ${user.uid}
      Current Logs: ${JSON.stringify(receipts.map(r => ({ amount: r.amount, category: r.category, date: r.date, loc: r.location })))}
      User Message: ${prompt}
    `;
    
    let retries = 0;
    const backoff = (ms) => new Promise(res => setTimeout(res, ms));

    while (retries < 5) {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: context }] }],
            systemInstruction: { parts: [{ text: "You are a specialized Logistics & Driver Accounting Assistant. Your job is to help truck and delivery drivers manage their business expenses. Use the provided logs to answer specific questions. Suggest optimizations for fuel spending or maintenance cycles. Always be professional and concise." }] }
          })
        });
        
        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "I'm sorry, I couldn't generate a response.";
        setChatHistory(prev => [...prev, { role: 'assistant', text }]);
        setIsAiTyping(false);
        return;
      } catch (err) {
        retries++;
        await backoff(Math.pow(2, retries) * 1000);
      }
    }
    setChatHistory(prev => [...prev, { role: 'assistant', text: "Connection error with AI. Please try again." }]);
    setIsAiTyping(false);
  };

  const handleChatSubmit = (e) => {
    e.preventDefault();
    if (!chatInput.trim()) return;
    const msg = chatInput;
    setChatHistory(prev => [...prev, { role: 'user', text: msg }]);
    setChatInput('');
    callGemini(msg);
  };

  const totalSpent = receipts.reduce((sum, r) => sum + r.amount, 0);

  /**
   * UI RENDER
   */
  return (
    <div className="flex flex-col h-screen bg-slate-50 text-slate-900 font-sans max-w-md mx-auto border-x border-slate-200 shadow-2xl overflow-hidden relative">
      
      {/* Header */}
      <header className="p-4 bg-white border-b border-slate-200 flex items-center justify-between z-10">
        <div>
          <h1 className="text-xl font-black text-blue-600 flex items-center gap-2 italic">
            <TrendingUp size={22} className="not-italic" /> DRIVER-HUB
          </h1>
          <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Enterprise Logistics Tool</p>
        </div>
        <div className="flex items-center gap-2">
            <span className="text-[10px] font-mono text-slate-400 hidden sm:block">ID: {user?.uid.slice(0, 8)}</span>
            <div className="h-8 w-8 rounded-lg bg-blue-600 flex items-center justify-center text-white shadow-md font-bold text-xs">
                {user ? "A" : "?"}
            </div>
        </div>
      </header>

      {/* Main Content Area */}
      <main className="flex-1 overflow-y-auto pb-24">
        {activeTab === 'logs' && (
          <div className="p-4 space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            {/* Summary Card */}
            <div className="bg-gradient-to-br from-blue-600 to-blue-800 text-white rounded-3xl p-6 shadow-xl shadow-blue-200">
              <div className="flex justify-between items-start mb-4">
                <div>
                  <p className="text-blue-100 text-xs font-bold uppercase tracking-wider mb-1">Lifetime Expenses</p>
                  <h2 className="text-4xl font-black tracking-tight">${totalSpent.toLocaleString(undefined, { minimumFractionDigits: 2 })}</h2>
                </div>
                <div className="bg-white/10 p-3 rounded-2xl backdrop-blur-md">
                  <Receipt className="text-white" size={24} />
                </div>
              </div>
              <div className="flex gap-4 text-xs font-medium text-blue-100">
                <span className="flex items-center gap-1"><History size={14} /> {receipts.length} Entries</span>
                <span className="flex items-center gap-1"><Calendar size={14} /> Updated Live</span>
              </div>
            </div>

            {/* List Header */}
            <div className="flex justify-between items-center">
              <h3 className="font-bold text-slate-800 text-lg">Activity Log</h3>
              <button 
                onClick={() => setShowAddModal(true)}
                className="bg-blue-600 text-white text-xs font-bold px-4 py-2 rounded-full hover:bg-blue-700 transition-all shadow-md active:scale-95 flex items-center gap-2"
              >
                <Plus size={14} /> Add Log
              </button>
            </div>

            {/* List */}
            {loading ? (
              <div className="flex flex-col items-center justify-center py-20 text-slate-400 gap-3">
                <Loader2 className="animate-spin" size={32} />
                <p className="text-sm font-medium">Syncing with Cloud...</p>
              </div>
            ) : receipts.length === 0 ? (
              <div className="text-center py-16 px-6 bg-white rounded-3xl border-2 border-dashed border-slate-200">
                <div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <Receipt className="text-slate-300" size={32} />
                </div>
                <h4 className="font-bold text-slate-700">No Logs Found</h4>
                <p className="text-xs text-slate-400 mt-2 leading-relaxed">
                  Start by adding an expense manually or use the calculator to push your trip totals here.
                </p>
              </div>
            ) : (
              <div className="space-y-3">
                {receipts.map(r => (
                  <div key={r.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center group hover:border-blue-200 transition-colors">
                    <div className="flex gap-4 items-center">
                      <div className={`p-3 rounded-xl ${r.category === 'Fuel' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'}`}>
                        {r.category === 'Fuel' ? <MapPin size={20}/> : <Receipt size={20}/>}
                      </div>
                      <div>
                        <h4 className="font-black text-slate-800 text-lg leading-tight">${r.amount.toFixed(2)}</h4>
                        <div className="flex items-center gap-2 mt-1">
                            <span className="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded uppercase">{r.category}</span>
                            <span className="text-[10px] text-slate-400 font-medium italic">{r.location || 'Logged Entry'}</span>
                        </div>
                      </div>
                    </div>
                    <button 
                      onClick={() => deleteReceipt(r.id)}
                      className="p-2 text-slate-200 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all"
                    >
                      <Trash2 size={18} />
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {activeTab === 'calc' && (
          <div className="p-6 h-full flex flex-col animate-in fade-in slide-in-from-right-4 duration-500">
             {/* Display */}
             <div className="bg-slate-900 text-white rounded-3xl p-8 mb-6 shadow-2xl relative overflow-hidden ring-4 ring-slate-100">
                <div className="absolute top-0 right-0 p-4 opacity-10">
                    <Calculator size={80} />
                </div>
                <div className="text-right text-blue-400/60 text-sm font-mono h-6 mb-1">
                  {calcMemory !== null ? `${calcMemory} ${calcOperator || ''}` : ''}
                </div>
                <div className="text-right text-5xl font-mono font-bold truncate">
                  {calcDisplay}
                </div>
             </div>

             {/* Buttons */}
             <div className="grid grid-cols-4 gap-4 flex-1">
                {[7, 8, 9, '/'].map(val => (
                  <button 
                    key={val} 
                    onClick={() => typeof val === 'number' ? handleDigit(val) : handleOperator(val)} 
                    className={`h-16 rounded-2xl font-bold text-xl transition-all active:scale-90 shadow-sm
                        ${typeof val === 'number' ? 'bg-white text-slate-700 hover:bg-slate-50' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}
                  >
                    {val === '/' ? 'รท' : val}
                  </button>
                ))}
                {[4, 5, 6, '*'].map(val => (
                  <button 
                    key={val} 
                    onClick={() => typeof val === 'number' ? handleDigit(val) : handleOperator(val)} 
                    className={`h-16 rounded-2xl font-bold text-xl transition-all active:scale-90 shadow-sm
                        ${typeof val === 'number' ? 'bg-white text-slate-700 hover:bg-slate-50' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}
                  >
                    {val === '*' ? 'ร' : val}
                  </button>
                ))}
                {[1, 2, 3, '-'].map(val => (
                  <button 
                    key={val} 
                    onClick={() => typeof val === 'number' ? handleDigit(val) : handleOperator(val)} 
                    className={`h-16 rounded-2xl font-bold text-xl transition-all active:scale-90 shadow-sm
                        ${typeof val === 'number' ? 'bg-white text-slate-700 hover:bg-slate-50' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}
                  >
                    {val}
                  </button>
                ))}
                <button onClick={() => handleDigit(0)} className="h-16 rounded-2xl bg-white text-slate-700 font-bold text-xl transition-all active:scale-90 shadow-sm hover:bg-slate-50">0</button>
                <button onClick={clearCalc} className="h-16 rounded-2xl bg-red-50 text-red-600 font-bold text-xl transition-all active:scale-90 shadow-sm hover:bg-red-100">C</button>
                <button onClick={handleEqual} className="h-16 rounded-2xl bg-blue-600 text-white font-bold text-xl transition-all active:scale-90 shadow-lg shadow-blue-200 hover:bg-blue-700">=</button>
                <button onClick={() => handleOperator('+')} className="h-16 rounded-2xl bg-slate-200 text-slate-600 font-bold text-xl transition-all active:scale-90 shadow-sm hover:bg-slate-300">+</button>
             </div>

             <button 
                onClick={sendToReceipt}
                className="mt-8 w-full bg-slate-900 text-white py-5 rounded-2xl font-bold flex items-center justify-center gap-3 hover:bg-slate-800 transition-all shadow-xl active:scale-95"
             >
                <Receipt size={22} /> Export to Receipt Log
             </button>
          </div>
        )}

        {activeTab === 'ai' && (
          <div className="flex flex-col h-full bg-white animate-in fade-in slide-in-from-left-4 duration-500">
            {/* AI Header */}
            <div className="p-4 border-b border-slate-100 bg-blue-50/50 flex items-center gap-3">
              <div className="h-10 w-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-100">
                <BrainCircuit size={20} />
              </div>
              <div>
                <h3 className="text-sm font-black text-slate-800 leading-none">Smart Assistant</h3>
                <p className="text-[10px] text-blue-500 font-bold uppercase tracking-widest mt-1.5 flex items-center gap-1">
                    <span className="w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse"></span> Analyzing Data Live
                </p>
              </div>
            </div>

            {/* Chat History */}
            <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/30">
              {chatHistory.map((msg, i) => (
                <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[85%] p-4 rounded-2xl text-sm shadow-sm leading-relaxed ${
                    msg.role === 'user' 
                    ? 'bg-blue-600 text-white rounded-tr-none' 
                    : 'bg-white text-slate-800 rounded-tl-none border border-slate-100'
                  }`}>
                    {msg.text}
                  </div>
                </div>
              ))}
              {isAiTyping && (
                <div className="flex justify-start">
                  <div className="bg-white p-4 rounded-2xl rounded-tl-none border border-slate-100 flex items-center gap-2">
                    <div className="flex gap-1">
                        <div className="w-1.5 h-1.5 bg-slate-300 rounded-full animate-bounce"></div>
                        <div className="w-1.5 h-1.5 bg-slate-300 rounded-full animate-bounce delay-75"></div>
                        <div className="w-1.5 h-1.5 bg-slate-300 rounded-full animate-bounce delay-150"></div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Input Form */}
            <form onSubmit={handleChatSubmit} className="p-4 border-t border-slate-100 bg-white flex gap-3 pb-6">
              <input 
                value={chatInput}
                onChange={(e) => setChatInput(e.target.value)}
                placeholder="Ask about your fuel logs..."
                className="flex-1 px-5 py-3 rounded-2xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 text-sm transition-all shadow-inner"
              />
              <button className="h-12 w-12 bg-blue-600 text-white rounded-2xl flex items-center justify-center hover:bg-blue-700 active:scale-90 transition-all shadow-lg shadow-blue-100">
                <Send size={20} />
              </button>
            </form>
          </div>
        )}
      </main>

      {/* Modern Tab Navigation */}
      <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/80 backdrop-blur-xl border-t border-slate-200 h-24 px-8 flex items-center justify-between pb-6 z-40">
        <button 
          onClick={() => setActiveTab('logs')}
          className={`flex flex-col items-center gap-1.5 transition-all duration-300 ${activeTab === 'logs' ? 'text-blue-600 -translate-y-1' : 'text-slate-400 hover:text-slate-600'}`}
        >
          <div className={`p-1.5 rounded-lg ${activeTab === 'logs' ? 'bg-blue-50' : ''}`}>
            <Receipt size={24} />
          </div>
          <span className="text-[10px] font-black uppercase tracking-tighter">Receipts</span>
        </button>
        <button 
          onClick={() => setActiveTab('calc')}
          className={`flex flex-col items-center gap-1.5 transition-all duration-300 ${activeTab === 'calc' ? 'text-blue-600 -translate-y-1' : 'text-slate-400 hover:text-slate-600'}`}
        >
          <div className={`p-1.5 rounded-lg ${activeTab === 'calc' ? 'bg-blue-50' : ''}`}>
            <Calculator size={24} />
          </div>
          <span className="text-[10px] font-black uppercase tracking-tighter">Calc</span>
        </button>
        <button 
          onClick={() => setActiveTab('ai')}
          className={`flex flex-col items-center gap-1.5 transition-all duration-300 ${activeTab === 'ai' ? 'text-blue-600 -translate-y-1' : 'text-slate-400 hover:text-slate-600'}`}
        >
          <div className={`p-1.5 rounded-lg ${activeTab === 'ai' ? 'bg-blue-50' : ''}`}>
            <BrainCircuit size={24} />
          </div>
          <span className="text-[10px] font-black uppercase tracking-tighter">AI Asst</span>
        </button>
      </nav>

      {/* Modal Overlay for Adding Receipts */}
      {showAddModal && (
        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-md z-[60] flex items-end sm:items-center justify-center p-4">
          <div className="bg-white w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl animate-in fade-in slide-in-from-bottom-10 duration-500">
            <div className="p-8">
              <div className="flex justify-between items-center mb-8">
                <div>
                    <h3 className="text-2xl font-black text-slate-800">New Entry</h3>
                    <p className="text-xs text-slate-400 font-bold uppercase tracking-wider mt-1">Manual Expense Log</p>
                </div>
                <button onClick={() => setShowAddModal(false)} className="bg-slate-100 p-2 rounded-full text-slate-400 hover:text-red-500 transition-colors">
                  <X size={20} />
                </button>
              </div>

              <div className="space-y-6">
                <div className="relative">
                  <label className="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest ml-1">Total Amount</label>
                  <div className="relative">
                    <span className="absolute left-4 top-1/2 -translate-y-1/2 text-2xl font-black text-slate-400">$</span>
                    <input 
                        type="number" 
                        value={newReceipt.amount}
                        onChange={(e) => setNewReceipt({...newReceipt, amount: e.target.value})}
                        className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 pl-10 font-black text-3xl focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all"
                        placeholder="0.00"
                    />
                  </div>
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest ml-1">Category</label>
                    <select 
                      value={newReceipt.category}
                      onChange={(e) => setNewReceipt({...newReceipt, category: e.target.value})}
                      className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-sm font-bold focus:border-blue-500 outline-none appearance-none"
                    >
                      <option>Fuel</option>
                      <option>Maintenance</option>
                      <option>Food</option>
                      <option>Tolls</option>
                      <option>Misc</option>
                    </select>
                  </div>
                  <div>
                    <label className="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest ml-1">Date</label>
                    <input 
                      type="date" 
                      value={newReceipt.date}
                      onChange={(e) => setNewReceipt({...newReceipt, date: e.target.value})}
                      className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-sm font-bold focus:border-blue-500 outline-none"
                    />
                  </div>
                </div>

                <div>
                  <label className="text-[10px] font-black text-slate-400 uppercase block mb-2 tracking-widest ml-1">Location / Details</label>
                  <input 
                    type="text" 
                    value={newReceipt.location}
                    onChange={(e) => setNewReceipt({...newReceipt, location: e.target.value})}
                    className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 text-sm font-bold focus:border-blue-500 outline-none placeholder:text-slate-300"
                    placeholder="e.g. Love's Travel Stop"
                  />
                </div>
              </div>

              <button 
                onClick={saveReceipt}
                className="w-full mt-10 bg-blue-600 text-white py-5 rounded-2xl font-black shadow-xl shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all text-lg"
              >
                Log Transaction
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;

